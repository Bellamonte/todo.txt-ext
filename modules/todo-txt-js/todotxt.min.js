var TodoTxt=function(){var z=/^\s+|\s+$/g,A=/\s+/,B=/^\d{4}$/,v=/^\d{2}$/,C=/^\([A-Z]\)$/,t=/^\s*$/,w=/[^\:]+\:[^\:]/,x=function(b){var k=function(b){for(var d=0;d<c.length;d++)if(c[d].id()===b.id())return d+1;return 0};b=b.split("\n");for(var c=[],f={},g=0;g<b.length;g++){var d=b[g];t.test(d)||c.push(q(d,k))}f.render=function(c,d){for(var b=f.items(c,d),a="",e=0;e<b.length;e++)""!==a&&(a+="\n"),a+=b[e].render();return a};f.items=function(d,b){var f=[];d||(d={});for(var a=0;a<c.length;a++){var e=
c[a];D(e,d)&&f.push(e)}if(r(b)){for(a=0;a<b.length;a++){e=b[a];"string"===typeof e&&(b[a]=e={field:e,direction:"asc"});if(!e.field)throw Error("Invalid sort "+e);if(-1===["priority","createdDate","completedDate","isComplete","lineNumber"].indexOf(e.field))throw Error("Cannot sort by this field: "+e.field);"desc"!==e.direction&&(e.direction="asc")}var h=null,l=function(a,e,c){var h=a[c.field](),b=e[c.field]();return function(){if(h===b)return 0;switch(c.field){case "isComplete":return"desc"===c.direction?
h?1:-1:h?-1:1;case "createdDate":case "completedDate":return null===h?1:null===b?-1:h.getTime()===b.getTime()?0:"desc"===c.direction?h<b?1:-1:h<b?-1:1;case "priority":return null===h?"desc"===c.direction?-1:1:null===b?"desc"===c.direction?1:-1:"desc"===c.direction?h<b?1:-1:h<b?-1:1;default:throw Error("Unhandled sort.field "+c.field);}}()};f.sort(function(a,e){try{for(var c=0;c<b.length;c++){if("lineNumber"===b[c].field){var d="desc"===b[c].direction;return a.lineNumber()===e.lineNumber()?0:a.lineNumber()<
e.lineNumber()?d?1:-1:d?-1:1}var f=l(a,e,b[c]);if(0!==f)return f}}catch(n){return h=n,0}return a.lineNumber()<e.lineNumber()?-1:1});if(h)throw Error(h);}return f};f.length=c.length;f.removeItem=function(b,d){"function"===typeof b.render&&(b=b.render());for(var g=[],a=0;a<c.length;a++)g[a]=c[a];for(var e=0,a=0;a<g.length;a++)if(g[a].render()===b){if(c.splice(e,1),!d)break}else e++;f.length=c.length};f.addItem=function(b){"function"===typeof b.render&&(b=b.render());b=q(b,k);b.createdDate()||b.setCreatedDate(new Date);
c.push(b);f.length=c.length;return b};f.collections=function(b){var d={},f={},a=[],e=[],h,l,g;for(h=0;h<c.length;h++)if(b||!c[h].isComplete()){var k=c[h].contexts(),m=c[h].projects();for(l=0;l<k.length;l++)d[k[l]]=!0;for(l=0;l<m.length;l++)f[m[l]]=!0}for(g in d)!0===d[g]&&a.push(g);for(g in f)!0===f[g]&&e.push(g);a.sort();e.sort();return{contexts:a,projects:e}};return f},D=function(b,k){for(var c in k)if(k.hasOwnProperty(c)){if(!b.hasOwnProperty(c))throw Error("This property is invalid for query: "+
c);var f=k[c],g=b[c](),d="direct";"function"===typeof f?d="function":r(f)&&(d="containsAll");switch(d){case "function":if(!f(g))return!1;break;case "containsAll":if(!r(g))throw Error("Cannot pass array for non-array property");for(d=0;d<f.length;d++){for(var n=!1,p=0;p<g.length;p++)if(f[d]===g[p]){n=!0;break}if(!n)return!1}break;case "direct":if(m(f)&&m(g))return c=f,c.getFullYear()===g.getFullYear()&&c.getMonth()===g.getMonth()&&c.getDate()===g.getDate();if(f!==g)return!1;break;default:throw Error("unexpected queryPropType: "+
d);}}return!0},q=function(b,k){var c,f=function(a){b=a.replace(z,"");c=[];""!==b&&(c=b.split(A))};if(!b||t.test(b))return null;f(b);var g="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var e=16*Math.random()|0;return("x"==a?e:e&3|8).toString(16)}),d={render:function(){return c.join(" ")},replaceWith:function(a){if(!a||t.test(a))throw Error("Cannot replace a line with nothing.");f(a)},id:function(){return g},isComplete:function(){return 0<c.length&&"x"===c[0]},completedDate:function(){return!d.isComplete()||
2>c.length?null:q(c[1])},priority:function(){var a=0;d.isComplete()&&(a++,d.completedDate()&&a++);if(c.length<=a)return null;a=c[a];return C.test(a)?a[1]:null},createdDate:function(){var a=0;d.isComplete()&&a++;d.completedDate()&&a++;d.priority()&&a++;return c.length<=a?null:q(c[a])},contexts:function(){for(var a={},e=0;e<c.length;e++){var b=c[e];2>b.length||"@"===b[0]&&(a[b]=!0)}return y(a,"boolean")},projects:function(){for(var a={},e=0;e<c.length;e++){var b=c[e];2>b.length||"+"===b[0]&&(a[b]=!0)}return y(a,
"boolean")},addons:function(){for(var a={},e=0;e<c.length;e++){var b=c[e];if(w.test(b)){var d=b.split(":"),b=d.splice(1),d=d[0],b=b.join(":");a[d]?r(a[d])?a[d].push(b):a[d]=[a[d],b]:a[d]=b}}return a},textTokens:function(){var a=[],e=0;d.isComplete()&&e++;d.completedDate()&&e++;d.priority()&&e++;for(d.createdDate()&&e++;e<c.length;e++){var b=c[e];"@"===b[0]||"+"===b[0]||w.test(b)||a.push(b)}return a},lineNumber:function(){return k(this)},completeTask:function(){d.isComplete()||c.splice(0,0,"x",u())},
uncompleteTask:function(){if(d.isComplete()){var a=1;m(d.completedDate())&&a++;c.splice(0,a)}},setCreatedDate:function(a){m(a)||(a=new Date);a=new Date(a.getFullYear(),a.getMonth(),a.getDate());var b=0,h=null===d.createdDate();d.priority()&&b++;d.completedDate()&&b++;d.isComplete()&&b++;c.splice(b,h?0:1,u(a))},addContext:function(a){if("string"!==typeof a||/^\s*$/.test(a))throw Error("Invalid context: "+a);"@"!==a[0]&&(a="@"+a);for(var b=d.contexts(),h=0;h<b.length;h++)if(b[h]===a)return;c.push(a)},
addProject:function(a){if("string"!==typeof a||/^\s*$/.test(a))throw Error("Invalid project: "+a);"+"!==a[0]&&(a="+"+a);for(var b=d.projects(),h=0;h<b.length;h++)if(b[h]===a)return;c.push(a)},removeContext:function(a){if("string"!==typeof a||/^\s*$/.test(a))throw Error("Invalid context: "+a);"@"!==a[0]&&(a="@"+a);p(a)},removeProject:function(a){if("string"!==typeof a||/^\s*$/.test(a))throw Error("Invalid project: "+a);"+"!==a[0]&&(a="+"+a);p(a)},setAddOn:function(a,b){var d;if("string"!==typeof a||
/^\s*$/.test(a)||-1<["@","+"].indexOf(a[0]))throw Error("Invalid addon name: "+a);b=m(b)?u(b):b.toString();var f=null,g=n(c,function(b){return b.substr(0,a.length+1)===a+":"});0<g.length&&(f=g[0],g.splice(0,1));g.reverse();for(d=0;d<g.length;d++)c.splice(g[d],1);d=a+":"+b;null===f?c.push(d):c.splice(f,1,d)},removeAddOn:function(a){if("string"!==typeof a||/^\s*$/.test(a)||-1<["@","+"].indexOf(a[0]))throw Error("Invalid addon name: "+a);p(function(b){return b.substr(0,a.length+1)===a+":"})}},n=function(a,
b){if("function"!==typeof b){var c=b.toString();b=function(a){return a===c}}for(var d=[],f=0;f<a.length;f++)b(a[f])&&d.push(f);return d},p=function(a){a=n(c,a);a.reverse();for(var b=0;b<a.length;b++)c.splice(a[b],1)},q=function(a){var b=a.split("-");if(3!==b.length)return null;a=b[0];var c=b[1],d=b[2];if(!(B.test(a)&&v.test(c)&&v.test(d)))return null;b=b.join("/");b=new Date(b);if("Invalid Date"===b.toString())return null;a=parseInt(a,10);c=parseInt(c,10);d=parseInt(d,10);return b.getFullYear()!==
a||b.getMonth()!==c-1||b.getDate()!==d?null:b};return d},u=function(b){m(b)||(b=new Date);var k=function(b,f){for(var g=b.toString();g.length<f;)g="0"+g;return g};return b.getFullYear()+"-"+k(b.getMonth()+1,2)+"-"+k(b.getDate(),2)},r=function(b){return Array.isArray?Array.isArray(b):"[object Array]"===Object.prototype.toString.call(b)},m=function(b){return b&&"object"==typeof b&&"[object Date]"==toString.call(b)||!1},y=function(b,k){var c=[],f;for(f in b)b.hasOwnProperty(f)&&(k&&typeof b[f]!==k||
c.push(f));return c};return{SORT_ASC:"asc",SORT_DESC:"desc",parseFile:x,create:function(){return x("")},parseLine:function(b){return q(b,0)}}}();
